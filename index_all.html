<!DOCTYPE html>
<html>

<head>
    <title>AI Chat</title>
    <!-- æ·»åŠ  KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <!-- æ·»åŠ  KaTeX JS -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <!-- æ·»åŠ  auto-render æ‰©å±•ï¼Œç”¨äºè‡ªåŠ¨æ¸²æŸ“é¡µé¢ä¸­çš„æ•°å­¦å…¬å¼ -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- æ·»åŠ  highlight.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/vs2015.min.css">

    <!-- æ·»åŠ  highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <!-- æ·»åŠ å¸¸ç”¨è¯­è¨€åŒ… -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/cpp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/javascript.min.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --background-color: #f8f9fa;
            --sidebar-color: #2c3e50;
            --text-color: #2c3e50;
            --border-color: #e9ecef;
            --hover-color: #3498db;
            --message-user-bg: #e3f2fd;
            --message-ai-bg: #e8f5e9;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            color: var(--text-color);
            background: var(--background-color);
        }

        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            width: 280px;
            height: 100vh;
            background: var(--sidebar-color);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            color: white;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 999;
            flex-shrink: 0;
            /* é˜²æ­¢ä¾§è¾¹æ è¢«å‹ç¼© */
            transition: transform 0.3s ease;
            /* æ·»åŠ è¿‡æ¸¡æ•ˆæœ */
        }

        .sidebar.hidden {
            transform: translateX(-100%);
            /* ä½¿ç”¨ transform è€Œä¸æ˜¯ width æ¥éšè— */
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 8px;
            background: var(--sidebar-color);
            position: sticky;
            top: 0;
            z-index: 2;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            height: calc(100vh - 70px);
            /* å‡å»å¤´éƒ¨é«˜åº¦ */
        }

        .chat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.1);
        }

        .chat-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        /* ä¸»å†…å®¹åŒºæ ·å¼ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 20px;
            position: relative;
            overflow: hidden;
            margin-left: 280px;
            /* é»˜è®¤çŠ¶æ€ä¸‹ä¸ä¾§è¾¹æ å®½åº¦å¯¹åº” */
            transition: margin-left 0.3s ease;
            /* æ·»åŠ è¿‡æ¸¡æ•ˆæœ */
        }

        .main-content.with-sidebar {
            margin-left: 280px;
        }

        /* å½“ä¾§è¾¹æ éšè—æ—¶çš„ä¸»å†…å®¹åŒºæ ·å¼ */
        .main-content.sidebar-hidden {
            margin-left: 0;
            /* ä¾§è¾¹æ éšè—æ—¶å–æ¶ˆå·¦è¾¹è· */
        }

        /* å†…å®¹åŒºåŸŸå®¹å™¨ */
        .content-wrapper {
            max-width: 2000px;
            /* ä»1600pxå¢åŠ åˆ°2000px */
            margin: 0 auto;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding-bottom: 90px;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            margin-bottom: 120px;
            /* ä¸ºè¾“å…¥åŒºåŸŸç•™å‡ºç©ºé—´ */
        }

        .chat-box {
            flex: 1;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            background: var(--background-color);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* å›ºå®šè¾“å…¥æ¡†åŒºåŸŸ */
        .input-area {
            position: fixed;
            bottom: 0;
            left: 280px;
            /* é»˜è®¤çŠ¶æ€ä¸‹ä¸ä¾§è¾¹æ å®½åº¦å¯¹åº” */
            right: 0;
            padding: 20px;
            background: white;
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            z-index: 100;
            transition: left 0.3s ease;
            /* æ·»åŠ è¿‡æ¸¡æ•ˆæœ */
        }

        /* å½“ä¾§è¾¹æ éšè—æ—¶çš„è¾“å…¥åŒºåŸŸæ ·å¼ */
        .sidebar-hidden .input-area {
            left: 0;
            /* ä¾§è¾¹æ éšè—æ—¶è¾“å…¥æ¡†å·¦è¾¹ç•Œä»0å¼€å§‹ */
        }

        #userInput {
            flex: 1;
            height: 45px;
            /* åˆå§‹ä¸€è¡Œé«˜åº¦ */
            min-height: 45px;
            /* æœ€å°ä¸€è¡Œé«˜åº¦ */
            max-height: 450px;
            /* æœ€å¤§10è¡Œé«˜åº¦ (45px * 10) */
            padding: 12px 20px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            line-height: 1.5;
            resize: none;
            overflow-y: auto;
        }

        #userInput:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: var(--accent-color);
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .sidebar button {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            font-size: 16px;
        }

        .sidebar button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .markdown-body {
            padding: 8px;
            line-height: 1.2;
            word-wrap: break-word;
            white-space: pre-wrap;
            font-size: 20px;
        }

        /* Markdown åˆ—è¡¨æ ·å¼ */
        .markdown-body ul,
        .markdown-body ol {
            padding-left: 1.5em;
            /* ç¼©è¿›è·ç¦» */
            margin: 0em 0;
            /* ä¸Šä¸‹é—´è· */
        }

        .markdown-body ul li,
        .markdown-body ol li {
            margin: 0em 0;
            /* åˆ—è¡¨é¡¹ä¹‹é—´çš„é—´è· */
            line-height: 1.2;
            /* åˆ—è¡¨é¡¹çš„è¡Œé«˜ */
        }

        /* æ— åºåˆ—è¡¨çš„ç¬¦å·æ ·å¼ */
        .markdown-body ul {
            list-style-type: disc;
            /* å®å¿ƒåœ†ç‚¹ */
        }

        /* æœ‰åºåˆ—è¡¨çš„æ•°å­—æ ·å¼ */
        .markdown-body ol {
            list-style-type: decimal;
            /* æ•°å­—æ ·å¼ */
        }

        .markdown-body p {
            margin: 0em 0;
        }

        /* .markdown-body pre {
            background-color: #f8f9fa;
            padding: 6px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid var(--border-color);
            margin: 0.5em 0;
        } */

        /* Markdown è¡¨æ ¼æ ·å¼ */
        .markdown-body table {
            border-collapse: collapse;
            /* åˆå¹¶è¾¹æ¡† */
            width: 100%;
            /* è¡¨æ ¼å®½åº¦ä¸º100% */
            margin: 1em 0;
            /* ä¸Šä¸‹é—´è· */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            /* æ·»åŠ é˜´å½±æ•ˆæœ */
            border-radius: 8px;
            /* åœ†è§’ */
            overflow: hidden;
            /* ç¡®ä¿åœ†è§’æ•ˆæœ */
        }

        .markdown-body th,
        .markdown-body td {
            border: 1px solid #ddd;
            /* å•å…ƒæ ¼è¾¹æ¡† */
            padding: 12px;
            /* å•å…ƒæ ¼å†…è¾¹è· */
            text-align: left;
            /* å·¦å¯¹é½æ–‡æœ¬ */
        }

        .markdown-body th {
            background: #3498db;
            /* è¡¨å¤´èƒŒæ™¯è‰² */
            color: white;
            /* è¡¨å¤´æ–‡å­—é¢œè‰² */
            font-weight: bold;
            /* è¡¨å¤´åŠ ç²— */
        }

        .markdown-body tr:nth-child(even) {
            background: #f2f2f2;
            /* å¶æ•°è¡ŒèƒŒæ™¯è‰² */
        }

        .markdown-body tr:hover {
            background: #e9ecef;
            /* é¼ æ ‡æ‚¬åœæ—¶çš„èƒŒæ™¯è‰² */
        }

        .markdown-body tr {
            transition: background 0.3s;
            /* æ·»åŠ è¿‡æ¸¡æ•ˆæœ */
        }

        /* ä»£ç å—æ ·å¼ */
        .markdown-body pre {
            margin: 0.5em 0;
            padding: 0.5em;
            border-radius: 6px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            overflow: auto;
            position: relative;
            padding-top: 1.8em;
        }

        .markdown-body code {
            background-color: #f8f9fa;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            border: 1px solid var(--border-color);
            white-space: pre;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 10px;
            max-width: 1600px;
            /* ä»800pxå¢åŠ åˆ°1200px */
            position: relative;
            line-height: 1.5;
            word-wrap: break-word;
            white-space: normal;
            font-size: 20px;
            /* å›ºå®šå­—ä½“å¤§å° */
        }

        .message.user {
            background: var(--message-user-bg);
            margin-left: auto;
            border-bottom-right-radius: 4px;
            width: fit-content;
            min-width: 200px;
        }

        .message.assistant {
            background: var(--message-ai-bg);
            margin-right: auto;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            width: fit-content;
            min-width: 200px;
        }

        /* æ¶ˆæ¯æ ‡é¢˜æ æ ·å¼ */
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-radius: 8px 8px 0 0;
            margin-bottom: -1px;
        }

        /* ç”¨æˆ·æ¶ˆæ¯æ ‡é¢˜æ  */
        .message.user .message-header {
            background: #d4e9fc;
            border: 1px solid #c7e2fb;
        }

        /* AIæ¶ˆæ¯æ ‡é¢˜æ  */
        .message.assistant .message-header {
            background: #dcf1dd;
            border: 1px solid #cfebd0;
        }

        /* è°ƒæ•´æ¶ˆæ¯å†…å®¹æ ·å¼ */
        .message-content {
            padding: 12px 16px;
            border-radius: 0 0 10px 10px;
        }

        /* ç”¨æˆ·æ¶ˆæ¯å†…å®¹ */
        .message.user .message-content {
            background: var(--message-user-bg);
        }

        /* AIæ¶ˆæ¯å†…å®¹ */
        .message.assistant .message-content {
            background: var(--message-ai-bg);
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* ä¿®æ”¹æœç´¢æ¡†æ ·å¼ */
        .search-container {
            position: fixed;
            top: 10px;
            left: 60px;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .search-container.active {
            display: flex;
        }

        .search-container input {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            width: 200px;
        }

        .search-container button {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: var(--accent-color);
            color: white;
            transition: all 0.3s ease;
        }

        .search-container button:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        /* æ·»åŠ åœæ­¢å›¾æ ‡æ ·å¼ */

        .stop-icon {

            width: 12px;

            height: 12px;

            background: white;

            border-radius: 2px;

        }

        /* æ·»åŠ å‘é€å›¾æ ‡æ ·å¼ */
        .send-icon {
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 14px solid white;
            margin-left: 4px;
        }

        /* ç¦ç”¨çŠ¶æ€æ ·å¼ */
        .send-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        /* ä¿®æ”¹ä¾§è¾¹æ å¤´éƒ¨æŒ‰é’®æ ·å¼ */
        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .sidebar-header button {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .sidebar-header button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* æ·»åŠ å›ºå®šçš„åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .toggle-button {
            position: fixed;
            left: 10px;
            top: 10px;
            z-index: 1000;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--accent-color);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .toggle-button:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        /* æœç´¢é«˜äº®æ ·å¼ */
        .highlight {
            background-color: yellow;
            padding: 2px;
            border-radius: 2px;
        }

        /* æ·»åŠ å½“å‰å¯¹è¯çš„æ ·å¼ */
        .chat-item.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .chat-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 10px;
        }

        .delete-btn {
            opacity: 0;
            transition: opacity 0.2s ease;
            background: transparent;
            border: none;
            color: #ff4d4f;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
        }

        .chat-item:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn:hover {
            background: rgba(255, 59, 48, 0.2);
        }

        /* ç¾åŒ–æ»šåŠ¨æ¡ */
        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* è¡Œå†…å…¬å¼æ ·å¼ */
        .mjx-math {
            font-size: 90% !important;
        }

        /* è¡Œé—´å…¬å¼æ ·å¼ */
        mjx-container[jax="SVG"][display="true"] {
            font-size: 90% !important;
            margin: 0.5em 0 !important;
            text-align: center;
        }

        /* ç¡®ä¿å…¬å¼å®¹å™¨ä¸ä¼šæº¢å‡º */
        mjx-container {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
        }

        /* è°ƒæ•´å…¬å¼ä¸æ–‡æœ¬çš„å¯¹é½ */
        mjx-container:not([display="true"]) {
            vertical-align: middle;
        }

        /* ç‰¹åˆ«å¤„ç†è¡Œå†…å…¬å¼çš„å¤§å° */
        .message mjx-container:not([display="true"]) {
            font-size: 80% !important;
        }

        /* è°ƒæ•´ KaTeX æ ·å¼ */
        .katex {
            font-size: 1em !important;
        }

        .katex-display {
            margin: 0.5em 0 !important;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .katex-display>.katex {
            white-space: normal;
        }

        /* å¤„ç†é•¿å…¬å¼ */
        .katex-display>.katex>.katex-html {
            overflow-x: auto;
            overflow-y: hidden;
            padding-left: 2px;
            padding-right: 2px;
        }

        /* å½“ä¾§è¾¹æ æ˜¾ç¤ºæ—¶è°ƒæ•´è¾“å…¥æ¡†ä½ç½® */
        .main-content.with-sidebar .input-area {
            left: calc(50% + 140px);
        }

        /* æ·»åŠ æç¤ºæ–‡æœ¬æ ·å¼ */
        .hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            padding-left: 20px;
        }

        /* æ·»åŠ å‘é€æŒ‰é’®æ ·å¼ */
        .send-button {
            width: 45px;
            /* ä¸è¾“å…¥æ¡†é«˜åº¦ä¸€è‡´ */
            height: 45px;
            /* ä¸è¾“å…¥æ¡†é«˜åº¦ä¸€è‡´ */
            border: none;
            border-radius: 8px;
            background: var(--accent-color);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            /* æ·»åŠ è¿™è¡Œä»¥æ”¹å–„æ–‡å­—å‚ç›´å¯¹é½ */
            padding: 0;
            /* ç§»é™¤å†…è¾¹è·ä»¥ç¡®ä¿å®Œå…¨å±…ä¸­ */
        }

        .button-icon {
            font-size: 24px;
            display: flex;
            /* æ·»åŠ è¿™è¡Œ */
            align-items: center;
            /* æ·»åŠ è¿™è¡Œ */
            justify-content: center;
            /* æ·»åŠ è¿™è¡Œ */
            width: 100%;
            /* æ·»åŠ è¿™è¡Œ */
            height: 100%;
            /* æ·»åŠ è¿™è¡Œ */
            transition: all 0.3s ease;
        }


        /* ä»£ç å—æ ‡é¢˜æ æ ·å¼ */
        .code-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1.3em;
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            font-size: 0.9em;
            color: #495057;
            border-radius: 5px 5px 0 0;
        }

        /* è¯­è¨€æ ‡é¢˜æ ·å¼ */
        .code-language {
            font-family: 'Consolas', monospace;
            font-size: 0.9em;
            color: #495057;
        }

        /* å¤åˆ¶æŒ‰é’®æ ·å¼ */
        .copy-button {
            position: absolute;
            /* ç»å¯¹å®šä½ */
            top: 10px;
            /* è·ç¦»é¡¶éƒ¨10px */
            right: 10px;
            /* è·ç¦»å³ä¾§10px */
            background: rgba(52, 152, 219, 0.8);
            /* æŒ‰é’®èƒŒæ™¯è‰² */
            color: white;
            /* æŒ‰é’®æ–‡å­—é¢œè‰² */
            border: none;
            /* æ— è¾¹æ¡† */
            border-radius: 4px;
            /* åœ†è§’ */
            padding: 5px 10px;
            /* å†…è¾¹è· */
            cursor: pointer;
            /* é¼ æ ‡æŒ‡é’ˆæ ·å¼ */
            font-size: 0.9em;
            /* å­—ä½“å¤§å° */
            transition: background 0.3s;
            /* æ·»åŠ è¿‡æ¸¡æ•ˆæœ */
        }

        .copy-button:hover {
            color: var(--accent-color);
        }

        /* å¤åˆ¶æˆåŠŸæç¤ºæ ·å¼ */
        .copy-button.copied {
            color: #28a745;
        }

        /* ä»£ç å—åŸºç¡€æ ·å¼ - GitHub é£æ ¼çš„æµ…ç°è‰²èƒŒæ™¯
         * ç”¨äºæ‰€æœ‰ä»£ç å—çš„èƒŒæ™¯è‰²å’ŒåŸºæœ¬æ–‡æœ¬é¢œè‰²
         * åŒ…æ‹¬è¡Œå†…ä»£ç å’Œå¤šè¡Œä»£ç å—
         */
        .hljs {
            background: #f6f8fa !important;
            color: #24292e !important;
        }

        /* å…³é”®å­— - GitHub é£æ ¼çš„çº¢è‰²
         * ç”¨äºè¯­è¨€å…³é”®å­—å’Œæ§åˆ¶æµè¯­å¥
         * ä¾‹å¦‚: if, else, return, class, import
         */
        .hljs-keyword {
            color: #d73a49 !important;
        }

        /* å­—ç¬¦ä¸² - GitHub é£æ ¼çš„è“è‰²
         * ç”¨äºå­—ç¬¦ä¸²å­—é¢é‡
         * ä¾‹å¦‚: "hello", 'world', `template`
         */
        .hljs-string {
            color: #032f62 !important;
        }

        /* æ³¨é‡Š - GitHub é£æ ¼çš„ç°è‰²
         * ç”¨äºå•è¡Œå’Œå¤šè¡Œæ³¨é‡Š
         * ä¾‹å¦‚: // æ³¨é‡Š, /* å¤šè¡Œæ³¨é‡Š */
        */ .hljs-comment {
            color: #57606a !important;
            font-style: italic !important;
        }


        /* å˜é‡å - GitHub é£æ ¼çš„æ·±è‰²
         * ç”¨äºå˜é‡å¼•ç”¨å’Œå£°æ˜
         * ä¾‹å¦‚: myVariable, counter, i
         */
        .hljs-variable {
            color: #24292e !important;
        }

        /* è¿ç®—ç¬¦ - GitHub é£æ ¼çš„æ·±è‰²
         * ç”¨äºç®—æœ¯ã€é€»è¾‘å’Œå…¶ä»–è¿ç®—ç¬¦
         * ä¾‹å¦‚: +, -, *, /, =, ==, !=, &&
         */
        .hljs-operator {
            color: #24292e !important;
        }

        /* æ ‡ç‚¹ç¬¦å· - GitHub é£æ ¼çš„æ·±è‰²
         * ç”¨äºåˆ†éš”ç¬¦å’Œæ ‡ç‚¹
         * ä¾‹å¦‚: (, ), {, }, [, ], ;, :
         */
        .hljs-punctuation {
            color: #24292e !important;
        }

        /* æ­£åˆ™è¡¨è¾¾å¼ - GitHub é£æ ¼çš„è“è‰²
         * ç”¨äºæ­£åˆ™è¡¨è¾¾å¼å­—é¢é‡
         * ä¾‹å¦‚: /\w+/, /[a-z]+/gi
         */
        .hljs-regexp {
            color: #032f62 !important;
        }

        /* å±æ€§å - GitHub é£æ ¼çš„æ·±è“è‰²
         * ç”¨äºå¯¹è±¡å±æ€§å’ŒHTMLå±æ€§
         * ä¾‹å¦‚: object.property, <div class="...">
         */
        .hljs-attr {
            color: #005cc5 !important;
        }

        /* HTML/XMLæ ‡ç­¾ - GitHub é£æ ¼çš„ç»¿è‰²
         * ç”¨äºæ ‡è®°è¯­è¨€çš„æ ‡ç­¾
         * ä¾‹å¦‚: <div>, <span>, <p>
         */
        .hljs-tag {
            color: #22863a !important;
        }

        /* å‡½æ•°å‚æ•° - GitHub é£æ ¼çš„æ·±è‰²
         * ç”¨äºå‡½æ•°å‚æ•°åˆ—è¡¨ä¸­çš„å‚æ•°å
         * ä¾‹å¦‚: function(param1, param2)
         */
        .hljs-params {
            color: #24292e !important;
        }

        /* æ–‡æ¡£æ ‡è®° - GitHub é£æ ¼çš„ç°è‰²
         * ç”¨äºæ–‡æ¡£æ³¨é‡Šä¸­çš„ç‰¹æ®Šæ ‡è®°
         * ä¾‹å¦‚: @param, @return, @throws
         */
        .hljs-doctag {
            color: #6a737d !important;
            font-style: italic !important;
        }

        /* å…ƒä¿¡æ¯ - GitHub é£æ ¼çš„è“è‰²
         * ç”¨äºé¢„å¤„ç†æŒ‡ä»¤å’Œå…ƒæ•°æ®æ ‡è®°
         * ä¾‹å¦‚: #include, #define, @decorator
         */
        .hljs-meta {
            color: #005cc5 !important;
        }

        /* å‡½æ•°ç›¸å…³æ ·å¼ - GitHubé£æ ¼çš„ç´«è‰²
         * ç”¨äºå‡½æ•°å£°æ˜å’Œå®šä¹‰çš„æ•´ä½“æ ·å¼
         * ä¾‹å¦‚: function myFunction(), def my_function():
         */
        .hljs-function {
            color: #8250df !important;
        }

        /* æ ‡é¢˜/åç§°æ ·å¼ - GitHubé£æ ¼çš„ç´«è‰²
         * ç”¨äºå„ç§æ ‡è¯†ç¬¦çš„åç§°
         * åŒ…æ‹¬å‡½æ•°åã€ç±»åç­‰
         */
        .hljs-title {
            color: #8250df !important;
        }

        /* ç±»åæ ·å¼ - GitHubé£æ ¼çš„ç´«è‰²
         * ä¸“é—¨ç”¨äºç±»çš„å£°æ˜å’Œå®šä¹‰
         * ä¾‹å¦‚: class MyClass, class Solution
         */
        .hljs-title.class_ {
            color: #8250df !important;
        }

        /* ç±»å‹å£°æ˜æ ·å¼ - GitHubé£æ ¼çš„çº¢è‰²
         * ç”¨äºç±»å‹å£°æ˜å’Œç±»å‹æ³¨è§£
         * ä¾‹å¦‚: int, string, boolean, void
         */
        .hljs-type {
            color: #cf222e !important;
        }


        /* è¡Œå†…ä»£ç æ ·å¼ä¿æŒä¸å˜ */
        #preview :not(pre)>code {
            background: #f6f8fa;
            padding: 2px 6px;
            border-radius: 4px;
            color: #e83e8c;
        }

        /* è¡¨æ ¼æ ·å¼ */
        #preview table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }

        #preview th,
        #preview td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        #preview th {
            background: #f8f9fa;
        }


        /* å‡½æ•°åç§° - ä½¿ç”¨ GitHub é£æ ¼çš„æ·±ç´«è‰²
         * ç”¨äºå‡½æ•°å£°æ˜å’Œè°ƒç”¨æ—¶çš„å‡½æ•°å
         * ä¾‹å¦‚: function calculate(), myFunction() 
         */
        .hljs-title.function_ {
            color: #6f42c1 !important;
        }

        /* å‡½æ•°åç§°ï¼ˆå¦ä¸€ç§é€‰æ‹©å™¨ï¼‰- ä¿æŒä¸ä¸Šé¢ç›¸åŒçš„æ·±ç´«è‰²
         * ç”¨äºç¡®ä¿ä¸åŒè¯­è¨€ä¸­çš„å‡½æ•°åéƒ½èƒ½æ­£ç¡®æ˜¾ç¤º
         * ä¾‹å¦‚: def my_function():, void myFunction() 
         */
        .hljs-function .hljs-title {
            color: #6f42c1 !important;
        }

        /* ç±»å‹åç§° - GitHub é£æ ¼çš„çº¢è‰²
         * ç”¨äºç±»å‹å£°æ˜å’Œç±»å‹æ³¨è§£
         * ä¾‹å¦‚: int, string, void, Vector<T> 
         */
        .hljs-type {
            color: #d73a49 !important;
        }

        /* å†…ç½®ç±»å‹/å‡½æ•° - GitHub é£æ ¼çš„çº¢è‰²
         * ç”¨äºè¯­è¨€å†…ç½®çš„ç±»å‹å’Œå‡½æ•°
         * ä¾‹å¦‚: string, int32, len(), sizeof() 
         */
        .hljs-built_in {
            color: #d73a49 !important;
        }

        /* æ•°å­—å­—é¢é‡ - GitHub é£æ ¼çš„æ·±è“è‰²
         * ç”¨äºæ‰€æœ‰æ•°å­—å¸¸é‡
         * ä¾‹å¦‚: 42, 3.14, 0xFF 
         */
        .hljs-number {
            color: #005cc5 !important;
        }

        /* å­—ç¬¦ä¸²æ’å€¼ä¸­çš„è¡¨è¾¾å¼ - æ·±ç°è‰²
         * ç”¨äºå­—ç¬¦ä¸²æ¨¡æ¿ä¸­çš„å˜é‡å’Œè¡¨è¾¾å¼
         * ä¾‹å¦‚: `${variable}`, f"{value}" 
         */
        .hljs-subst {
            color: #24292e !important;
        }

        /* æ¨¡æ¿å˜é‡ - æ·±ç°è‰²
         * ç”¨äºå„ç§æ¨¡æ¿è¯­è¨€ä¸­çš„å˜é‡
         * ä¾‹å¦‚: ${variable}, #{variable}, @{variable} 
         */
        .hljs-template-variable {
            color: #24292e !important;
        }

        /* è¡Œå†…ä»£ç æ ·å¼
        .markdown-body :not(pre) > code {
            background: #f6f8fa;
            padding: 2px 6px;
            border-radius: 4px;
            color: #e83e8c;
            border: 1px solid #e9ecef;
        } */
    </style>

    <script>
        // æ·»åŠ åœ¨å…¶ä»–è„šæœ¬çš„æœ€å‰é¢
        // é˜»æ­¢æµè§ˆå™¨é»˜è®¤çš„ Ctrl + æ»šè½®ç¼©æ”¾è¡Œä¸º
        document.addEventListener('wheel', function (e) {
            if (e.ctrlKey) {
                e.preventDefault();
            }
        }, { passive: false });

        // é…ç½® marked ä»¥å¤„ç†æ•°å­¦å…¬å¼
        marked.setOptions({
            breaks: true,
            gfm: true,
            pedantic: false,
            sanitize: false,
            smartLists: true,
            smartypants: false
        });

        // åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰æ¸²æŸ“å™¨æ¥å¤„ç†æ•°å­¦å…¬å¼
        const renderer = new marked.Renderer();
        const originalParagraph = renderer.paragraph.bind(renderer);
        renderer.paragraph = (text) => {
            return originalParagraph(text);
        };
        marked.setOptions({ renderer });
    </script>
</head>

<body>
    <!-- æ·»åŠ å›ºå®šçš„åˆ‡æ¢æŒ‰é’® -->
    <button class="toggle-button" onclick="toggleSidebar()">â‰¡</button>

    <!-- æœç´¢æ¡† -->
    <div class="search-container" id="searchContainer">
        <input type="text" id="searchInput" placeholder="æœç´¢...">
        <button onclick="performSearch()">ğŸ”</button>
        <button onclick="closeSearch()">âœ•</button>
    </div>

    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button onclick="showSearch()">ğŸ”</button>
            <button onclick="startNewChat()">+</button>
        </div>
        <div class="sidebar-content" id="chatHistory"></div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content" id="mainContent">
        <div class="content-wrapper">
            <div class="chat-container">
                <div id="chatBox" class="chat-box"></div>
            </div>
            <div class="input-area">
                <div style="display: flex; gap: 10px; align-items: flex-start;">
                    <textarea id="userInput" placeholder="è¾“å…¥é—®é¢˜... (Shift + Enter æ¢è¡Œï¼ŒEnter å‘é€)" rows="1"></textarea>
                    <button id="sendButton" class="send-button">
                        <span class="button-icon">â–¶</span>
                    </button>
                </div>
                <div class="hint">æç¤ºï¼šä½¿ç”¨ Shift + Enter æ¢è¡Œï¼ŒEnter å‘é€</div>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = 'sk-h7h4505fa57c4316b50bbb9784a454dh';  // ç›´æ¥æŒ‡å®šAPIå¯†é’¥
        const BASE_URL = 'https://api.deepseek.com';

        marked.setOptions({
            highlight: function (code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, {
                            language: lang,
                            ignoreIllegals: true
                        }).value;
                    } catch (e) {
                        console.error(e);
                    }
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        let messages = [{
            "role": "system",
            "content": `You are an AI expert, answer in Chinese and markdown format. Follow these formatting rules:
1. Use proper indentation for code blocks
2. Break long paragraphs into shorter ones for better readability
3. Add line breaks after every main point
4. When showing code, always specify the language after triple backticks
5. Keep lines under 80 characters when possible
6. Use proper markdown formatting for lists and headings
7. For mathematical formulas:
   - Use single $ for inline math expressions (e.g., $E=mc^2$)
   - Use double $$ for block math expressions (e.g., $$\\sum_{i=1}^n i = \\frac{n(n+1)}{2}$$)
   - Always use proper LaTeX syntax for math expressions`
        }];

        let isNewChat = true;  // æ·»åŠ æ ‡è®°æ¥åˆ¤æ–­æ˜¯å¦æ˜¯æ–°å¯¹è¯

        let currentChatIndex = null;  // æ·»åŠ å½“å‰å¯¹è¯ç´¢å¼•æ ‡è®°

        // æ·»åŠ å‘é€æŒ‰é’®ç›¸å…³çš„å˜é‡å’Œå‡½æ•°
        let controller;  // ç¡®ä¿ controller æ˜¯å…¨å±€å˜é‡
        let isGenerating = false;  // ç¡®ä¿ isGenerating æ˜¯å…¨å±€å˜é‡
        const sendButton = document.getElementById('sendButton');

        function setSendButtonToStop() {
            const sendButton = document.getElementById('sendButton');
            sendButton.classList.add('sending');
            sendButton.querySelector('.button-icon').innerHTML = '<div class="stop-icon"></div>';  // ä½¿ç”¨æ–¹å—å›¾æ ‡
            isGenerating = true;  // è®¾ç½®ä¸ºæ­£åœ¨ç”Ÿæˆ
        }

        function resetSendButton() {
            const sendButton = document.getElementById('sendButton');
            sendButton.classList.remove('sending');
            sendButton.querySelector('.button-icon').innerHTML = 'â–¶';  // æ¢å¤ä¸ºä¸‰è§’å½¢å›¾æ ‡
            isGenerating = false;  // è®¾ç½®ä¸ºä¸åœ¨ç”Ÿæˆ
        }

        async function sendMessage() {
            const userInput = document.getElementById('userInput');
            const text = userInput.value.trim();
            if (!text) return;

            // æ¸…é™¤æ¬¢è¿æ¶ˆæ¯
            if (isNewChat) {
                document.getElementById('chatBox').innerHTML = '';
            }

            appendMessage('user', text);
            userInput.value = '';
            messages.push({ "role": "user", "content": text });

            // é‡ç½®è¾“å…¥æ¡†é«˜åº¦
            userInput.style.height = 'auto';  // å…ˆè®¾ç½®ä¸º autoï¼Œä»¥ä¾¿è®¡ç®—é«˜åº¦
            userInput.style.height = `${userInput.scrollHeight}px`;  // è®¾ç½®ä¸ºå½“å‰å†…å®¹çš„é«˜åº¦

            try {
                controller = new AbortController();  // åˆ›å»ºæ–°çš„ AbortController
                setSendButtonToStop();  // è®¾ç½®æŒ‰é’®ä¸ºåœæ­¢çŠ¶æ€

                const response = await fetch(`${BASE_URL}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 8000,
                        stream: true,
                    }),
                    signal: controller.signal  // å°†ä¿¡å·ä¼ é€’ç»™ fetch
                });

                const chatBox = document.getElementById('chatBox');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message assistant';

                // åˆ›å»ºæ ‡é¢˜æ 
                const headerDiv = document.createElement('div');
                headerDiv.className = 'message-header';
                const titleSpan = document.createElement('span');
                titleSpan.textContent = 'AI';
                headerDiv.appendChild(titleSpan);

                // æ·»åŠ å¤åˆ¶æŒ‰é’®
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-button';
                copyButton.textContent = 'å¤åˆ¶';
                copyButton.onclick = async () => {
                    try {
                        await navigator.clipboard.writeText(fullResponse);
                        copyButton.textContent = 'å·²å¤åˆ¶!';
                        setTimeout(() => {
                            copyButton.textContent = 'å¤åˆ¶';
                        }, 2000);
                    } catch (err) {
                        console.error('å¤åˆ¶å¤±è´¥:', err);
                    }
                };
                headerDiv.appendChild(copyButton);

                // åˆ›å»ºå†…å®¹åŒºåŸŸ
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content markdown-body';

                // ç»„è£…æ¶ˆæ¯ç»“æ„
                messageDiv.appendChild(headerDiv);
                messageDiv.appendChild(contentDiv);
                chatBox.appendChild(messageDiv);

                let fullResponse = '';
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                // åœ¨å¼€å§‹æµå¼å¤„ç†å‰æ·»åŠ ç©ºçš„åŠ©æ‰‹æ¶ˆæ¯
                messages.push({ "role": "assistant", "content": "" });

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.choices[0].delta.content) {
                                    const content = data.choices[0].delta.content;
                                    fullResponse += content;

                                    // å¤„ç†æ•°å­¦å…¬å¼å’Œ Markdown
                                    const mathExpressions = [];
                                    let processedContent = fullResponse.replace(/\$\$(.*?)\$\$|\$(.*?)\$/gs, (match, block, inline) => {
                                        const id = mathExpressions.length;
                                        mathExpressions.push({
                                            type: match.startsWith('$$') ? 'block' : 'inline',
                                            content: block || inline
                                        });
                                        return `%%MATH_${id}%%`;
                                    });

                                    processedContent = marked.parse(processedContent);

                                    processedContent = processedContent.replace(/%%MATH_(\d+)%%/g, (match, id) => {
                                        const expr = mathExpressions[parseInt(id)];
                                        return expr.type === 'block'
                                            ? `\\[${expr.content}\\]`
                                            : `\\(${expr.content}\\)`;
                                    });

                                    contentDiv.innerHTML = processedContent;

                                    // æ¸²æŸ“æ•°å­¦å…¬å¼
                                    renderMathInElement(contentDiv, {
                                        delimiters: [
                                            { left: "\\[", right: "\\]", display: true },
                                            { left: "\\(", right: "\\)", display: false }
                                        ],
                                        throwOnError: false,
                                        output: 'html',
                                        strict: false
                                    });

                                    // ç¡®ä¿æ‰€æœ‰ä»£ç å—éƒ½è¢«é«˜äº®
                                    contentDiv.querySelectorAll('pre code').forEach((block) => {
                                        hljs.highlightBlock(block);
                                        // è·å–è¯­è¨€ç±»
                                        const languageClass = block.className.match(/language-(\w+)/) || [null, 'plaintext'];
                                        const language = languageClass[1];
                                        // æ·»åŠ æ ‡é¢˜æ å’Œå¤åˆ¶æŒ‰é’®
                                        createCodeHeader(block, language);
                                    });

                                    // ç¡®ä¿æ»šåŠ¨åˆ°åº•éƒ¨
                                    scrollToBottom();

                                    // æ›´æ–°æœ€åä¸€æ¡æ¶ˆæ¯çš„å†…å®¹
                                    messages[messages.length - 1].content = fullResponse;
                                }
                            } catch (e) {
                                console.error('Error parsing chunk:', e);
                            }
                        }
                    }
                }

                if (isNewChat) {
                    // ä¿®æ”¹è¿™é‡Œä½¿ç”¨ text è€Œä¸æ˜¯ userInput
                    saveToLocalStorage(text, fullResponse, [...messages]);
                    isNewChat = false;
                } else if (currentChatIndex !== null) {
                    // æ›´æ–°ç°æœ‰å¯¹è¯
                    const chats = JSON.parse(localStorage.getItem('chats') || '[]');
                    if (chats[currentChatIndex]) {
                        chats[currentChatIndex].messages = [...messages];
                        localStorage.setItem('chats', JSON.stringify(chats));
                    }
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Response generation was stopped');
                } else {
                    console.error('Error:', error);
                    appendMessage('system', 'å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•');
                }
            } finally {
                resetSendButton();  // é‡ç½®æŒ‰é’®çŠ¶æ€
                controller = null;  // æ¸…ç©º controller
            }
        }

        function appendMessage(role, content) {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            // åˆ›å»ºæ ‡é¢˜æ 
            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';

            // æ·»åŠ è§’è‰²æ ‡é¢˜
            const titleSpan = document.createElement('span');
            titleSpan.textContent = role === 'user' ? 'ç”¨æˆ·' : 'AI';
            headerDiv.appendChild(titleSpan);

            // æ·»åŠ å¤åˆ¶æŒ‰é’®
            const copyButton = document.createElement('button');
            copyButton.className = 'copy-button';
            copyButton.textContent = 'å¤åˆ¶';
            copyButton.onclick = async () => {
                try {
                    await navigator.clipboard.writeText(content);
                    copyButton.textContent = 'å·²å¤åˆ¶!';
                    setTimeout(() => {
                        copyButton.textContent = 'å¤åˆ¶';
                    }, 2000);
                } catch (err) {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                }
            };
            headerDiv.appendChild(copyButton);

            // åˆ›å»ºå†…å®¹åŒºåŸŸ
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (role === 'user') {
                // ç”¨æˆ·æ¶ˆæ¯ä¿æŒåŸå§‹æ ¼å¼
                contentDiv.innerHTML = content.replace(/\n/g, '<br>').replace(/ /g, '&nbsp;');
            } else {
                // AIæ¶ˆæ¯ä½¿ç”¨markdownæ¸²æŸ“
                contentDiv.className += ' markdown-body';

                // å…ˆå°†æ•°å­¦å…¬å¼éƒ¨åˆ†æå–å‡ºæ¥ï¼Œç”¨å ä½ç¬¦æ›¿ä»£
                const mathExpressions = [];
                let processedContent = content.replace(/\$\$(.*?)\$\$|\$(.*?)\$/gs, (match, block, inline) => {
                    const id = mathExpressions.length;
                    mathExpressions.push({
                        type: match.startsWith('$$') ? 'block' : 'inline',
                        content: block || inline
                    });
                    return `%%MATH_${id}%%`;
                });

                // æ¸²æŸ“ Markdown
                processedContent = marked.parse(processedContent);

                // è¿˜åŸæ•°å­¦å…¬å¼
                processedContent = processedContent.replace(/%%MATH_(\d+)%%/g, (match, id) => {
                    const expr = mathExpressions[parseInt(id)];
                    return expr.type === 'block'
                        ? `\\[${expr.content}\\]`
                        : `\\(${expr.content}\\)`;
                });

                contentDiv.innerHTML = `<div class="markdown-body">${processedContent}</div>`;

                // æ¸²æŸ“æ•°å­¦å…¬å¼
                renderMathInElement(contentDiv, {
                    delimiters: [
                        { left: "\\[", right: "\\]", display: true },
                        { left: "\\(", right: "\\)", display: false }
                    ],
                    throwOnError: false,
                    output: 'html',
                    strict: false
                });

                // å¤„ç†ä»£ç é«˜äº®ç­‰
                contentDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightBlock(block);
                    // è·å–è¯­è¨€ç±»
                    const languageClass = block.className.match(/language-(\w+)/) || [null, 'plaintext'];
                    const language = languageClass[1];
                    // æ·»åŠ æ ‡é¢˜æ å’Œå¤åˆ¶æŒ‰é’®
                    createCodeHeader(block, language);
                });
            }

            messageDiv.appendChild(headerDiv);
            messageDiv.appendChild(contentDiv);
            chatBox.appendChild(messageDiv);
            scrollToBottom();
        }

        function saveToLocalStorage(question, answer, allMessages) {
            const timestamp = new Date().toISOString();
            const chat = {
                timestamp,
                question,
                answer,
                messages: allMessages,
                title: generateChatTitle(question, answer)
            };

            let chats = JSON.parse(localStorage.getItem('chats') || '[]');
            chats.push(chat);
            currentChatIndex = chats.length - 1;  // è®¾ç½®å½“å‰å¯¹è¯ç´¢å¼•
            localStorage.setItem('chats', JSON.stringify(chats));
            updateChatHistory();
        }

        function generateChatTitle(question, answer) {
            // ä½¿ç”¨é—®é¢˜çš„å‰20ä¸ªå­—ç¬¦ä½œä¸ºæ ‡é¢˜
            return question.slice(0, 20) + (question.length > 20 ? '...' : '');
        }

        function updateChatHistory() {
            const historyDiv = document.getElementById('chatHistory');
            const chats = JSON.parse(localStorage.getItem('chats') || '[]');

            historyDiv.innerHTML = '';
            chats.reverse().forEach((chat, index) => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                if (currentChatIndex === (chats.length - 1 - index)) {
                    chatItem.classList.add('active');
                }

                // æ·»åŠ æ ‡é¢˜å®¹å™¨
                const titleDiv = document.createElement('div');
                titleDiv.className = 'chat-title';
                titleDiv.textContent = chat.title;
                titleDiv.onclick = () => loadChat(chats.length - 1 - index);

                // æ·»åŠ åˆ é™¤æŒ‰é’®
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = 'âœ•';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();  // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    deleteChat(chats.length - 1 - index);
                };

                chatItem.appendChild(titleDiv);
                chatItem.appendChild(deleteBtn);
                historyDiv.appendChild(chatItem);
            });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');

            sidebar.classList.toggle('hidden');
            mainContent.classList.toggle('sidebar-hidden');
        }

        let isSearchActive = false;
        let currentSearchTerm = '';

        function showSearch() {
            const searchContainer = document.getElementById('searchContainer');
            searchContainer.classList.add('active');
            document.getElementById('searchInput').focus();
        }

        function closeSearch() {
            const searchContainer = document.getElementById('searchContainer');
            searchContainer.classList.remove('active');
            document.getElementById('searchInput').value = '';
            isSearchActive = false;
            currentSearchTerm = '';
            updateChatHistory();  // æ¢å¤æ˜¾ç¤ºæ‰€æœ‰å†å²è®°å½•
        }

        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!searchTerm) return;

            isSearchActive = true;
            currentSearchTerm = searchTerm;
            const chats = JSON.parse(localStorage.getItem('chats') || '[]');

            // åœ¨æ ‡é¢˜å’Œå†…å®¹ä¸­æœç´¢
            const results = chats.filter(chat =>
                chat.question.toLowerCase().includes(searchTerm) ||
                chat.answer.toLowerCase().includes(searchTerm)
            );

            const historyDiv = document.getElementById('chatHistory');
            historyDiv.innerHTML = '';

            // æ˜¾ç¤ºæœç´¢ç»“æœ
            results.reverse().forEach((chat, index) => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';

                // é«˜äº®æ˜¾ç¤ºåŒ¹é…çš„æ–‡æœ¬
                let title = generateChatTitle(chat.question, chat.answer);
                if (title.toLowerCase().includes(searchTerm)) {
                    title = title.replace(new RegExp(searchTerm, 'gi'),
                        match => `<span class="highlight">${match}</span>`);
                }

                chatItem.innerHTML = title;

                // ä½¿ç”¨åŸå§‹ç´¢å¼•åŠ è½½æ­£ç¡®çš„å¯¹è¯
                const originalIndex = chats.findIndex(c =>
                    c.timestamp === chat.timestamp &&
                    c.question === chat.question
                );

                chatItem.onclick = () => {
                    loadChat(originalIndex);
                    // åœ¨åŠ è½½çš„å¯¹è¯å†…å®¹ä¸­ä¹Ÿé«˜äº®æ˜¾ç¤ºæœç´¢è¯
                    highlightSearchInChat(searchTerm);
                };

                historyDiv.appendChild(chatItem);
            });
        }

        // åœ¨å¯¹è¯å†…å®¹ä¸­é«˜äº®æ˜¾ç¤ºæœç´¢è¯
        function highlightSearchInChat(searchTerm) {
            const chatBox = document.getElementById('chatBox');
            const messages = chatBox.getElementsByClassName('message');

            Array.from(messages).forEach(message => {
                const content = message.innerHTML;
                message.innerHTML = content.replace(new RegExp(searchTerm, 'gi'),
                    match => `<span class="highlight">${match}</span>`);
            });
        }

        function startNewChat() {
            messages = [{
                "role": "system",
                "content": `You are an AI expert, answer in Chinese and markdown format. Follow these formatting rules:
1. Use proper indentation for code blocks
2. Break long paragraphs into shorter ones for better readability
3. Add line breaks after every main point
4. When showing code, always specify the language after triple backticks
5. Keep lines under 80 characters when possible
6. Use proper markdown formatting for lists and headings
7. For mathematical formulas:
   - Use single $ for inline math expressions (e.g., $E=mc^2$)
   - Use double $$ for block math expressions (e.g., $$\\sum_{i=1}^n i = \\frac{n(n+1)}{2}$$)
   - Always use proper LaTeX syntax for math expressions`
            }];

            document.getElementById('chatBox').innerHTML = '';

            // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
            const welcomeMessage = `## ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ AI åŠ©æ‰‹ï¼

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 12px 0;">
  <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #e9ecef;">
    <h4 style="margin: 0 0 4px 0;">ğŸ” è§£ç­”é—®é¢˜</h4>
    <div style="font-size: 0.9em; line-height: 1.3;">
    æŠ€æœ¯å’¨è¯¢ â€¢ æ¦‚å¿µè§£é‡Š â€¢ æ–¹æ¡ˆå»ºè®®
    </div>
  </div>
  <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #e9ecef;">
    <h4 style="margin: 0 0 4px 0;">ğŸ’» ç¼–ç¨‹è¾…åŠ©</h4>
    <div style="font-size: 0.9em; line-height: 1.3;">
    ä»£ç å®¡æŸ¥ â€¢ ç®—æ³•è®¾è®¡ â€¢ è°ƒè¯•å¸®åŠ©
    </div>
  </div>
  <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #e9ecef;">
    <h4 style="margin: 0 0 4px 0;">ğŸ“ æ–‡æ¡£åä½œ</h4>
    <div style="font-size: 0.9em; line-height: 1.3;">
    æ–‡æ¡£ç¼–å†™ â€¢ APIç”Ÿæˆ â€¢ æ³¨é‡Šä¼˜åŒ–
    </div>
  </div>
  <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #e9ecef;">
    <h4 style="margin: 0 0 4px 0;">ğŸ¯ é¡¹ç›®æ”¯æŒ</h4>
    <div style="font-size: 0.9em; line-height: 1.3;">
    æ¶æ„è®¾è®¡ â€¢ æ€§èƒ½ä¼˜åŒ– â€¢ å®‰å…¨å»ºè®®
    </div>
  </div>
</div>`;

            appendMessage('assistant', welcomeMessage);
            isNewChat = true;
            currentChatIndex = null;
            updateChatHistory();
        }

        function loadChat(index) {
            const chats = JSON.parse(localStorage.getItem('chats') || '[]');
            const chat = chats[index];
            if (chat && chat.messages) {
                currentChatIndex = index;  // è®¾ç½®å½“å‰å¯¹è¯ç´¢å¼•
                document.getElementById('chatBox').innerHTML = '';

                // åŠ è½½æ‰€æœ‰æ¶ˆæ¯
                messages = [...chat.messages];

                // æ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯
                chat.messages.forEach(msg => {
                    if (msg.role !== 'system') {
                        appendMessage(msg.role, msg.content);
                    }
                });

                isNewChat = false;
            }
        }

        window.onload = function () {
            updateChatHistory();
        };

        const input = document.getElementById('userInput');

        // æ·»åŠ è‡ªåŠ¨è°ƒæ•´é«˜åº¦çš„å‡½æ•°
        function adjustInputHeight() {
            const input = document.getElementById('userInput');
            const lineHeight = parseInt(window.getComputedStyle(input).lineHeight);
            // è®¡ç®—å½“å‰æ–‡æœ¬çš„è¡Œæ•°
            const lines = input.value.split('\n');
            // è®¾ç½®æœ€å¤§è¡Œæ•°ä¸º10
            const maxRows = 10;
            const rows = Math.min(lines.length, maxRows);
            // è®¾ç½®é«˜åº¦
            input.style.height = (rows * lineHeight) + 'px';
        }

        // æ·»åŠ è¾“å…¥äº‹ä»¶ç›‘å¬ï¼Œä»¥ä¾¿åœ¨ä»»ä½•è¾“å…¥æ—¶è°ƒæ•´é«˜åº¦
        document.getElementById('userInput').addEventListener('input', function () {
            adjustInputHeight(this);
        });

        // ç›‘å¬é”®ç›˜äº‹ä»¶
        document.getElementById('userInput').addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                if (e.shiftKey) {
                    // Shift + Enter: æ¢è¡Œå¹¶è°ƒæ•´é«˜åº¦
                    setTimeout(() => adjustInputHeight(this), 0);
                }
            }
        });

        // ä¿®æ”¹äº‹ä»¶ç›‘å¬å’Œå¤„ç†é€»è¾‘
        document.addEventListener('DOMContentLoaded', function () {
            const input = document.getElementById('userInput');

            // åªä¿ç•™å‘é€æ¶ˆæ¯çš„åŠŸèƒ½
            input.addEventListener('keydown', async function (e) {
                if (e.key === 'Enter') {
                    if (e.shiftKey) {
                        // Shift + Enter: æ¢è¡Œ
                        return;
                    } else {
                        // Enter: å‘é€
                        e.preventDefault();
                        const text = input.value.trim();
                        if (text) {
                            await sendMessage();
                        }
                    }
                }
            });
        });

        // æ·»åŠ åˆ é™¤å¯¹è¯çš„å‡½æ•°
        function deleteChat(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿ')) {
                let chats = JSON.parse(localStorage.getItem('chats') || '[]');
                chats.splice(index, 1);
                localStorage.setItem('chats', JSON.stringify(chats));

                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¯¹è¯ï¼Œæ¸…ç©ºèŠå¤©æ¡†å¹¶é‡ç½®çŠ¶æ€
                if (currentChatIndex === index) {
                    startNewChat();
                } else if (currentChatIndex > index) {
                    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¯¹è¯ä¹‹å‰çš„å¯¹è¯ï¼Œéœ€è¦è°ƒæ•´currentChatIndex
                    currentChatIndex--;
                }

                updateChatHistory();
            }
        }

        // æ·»åŠ æ»šåŠ¨åˆ°åº•éƒ¨çš„å‡½æ•°
        function scrollToBottom() {
            const chatBox = document.getElementById('chatBox');
            const chatContainer = document.querySelector('.chat-container');

            // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿åœ¨ä¸‹ä¸€å¸§æ¸²æŸ“æ—¶æ»šåŠ¨
            requestAnimationFrame(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }

        // ç§»é™¤æ‰€æœ‰ä¸ä¾§è¾¹æ ç¼©æ”¾ç›¸å…³çš„äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function () {
            // é˜»æ­¢ä¾§è¾¹æ çš„æ»šè½®ç¼©æ”¾
            const sidebar = document.querySelector('.sidebar');
            sidebar.addEventListener('wheel', function (e) {
                if (e.ctrlKey) {
                    e.preventDefault();
                }
            }, { passive: false });

            // é˜»æ­¢ä¾§è¾¹æ å†…å®¹çš„æ»šè½®ç¼©æ”¾
            const sidebarContent = document.querySelector('.sidebar-content');
            sidebarContent.addEventListener('wheel', function (e) {
                if (e.ctrlKey) {
                    e.preventDefault();
                }
            }, { passive: false });
        });

        // æ·»åŠ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        sendButton.addEventListener('click', function () {
            if (isGenerating) {
                // å¦‚æœæ­£åœ¨ç”Ÿæˆï¼Œåˆ™åœæ­¢
                controller.abort();  // ä¸­æ­¢è¯·æ±‚
                resetSendButton();  // é‡ç½®æŒ‰é’®çŠ¶æ€
            } else {
                // å¦‚æœä¸åœ¨ç”Ÿæˆï¼Œåˆ™å‘é€æ¶ˆæ¯
                sendMessage();
            }
        });

        // ä¿®æ”¹è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬
        userInput.addEventListener('input', function () {
            // å½“è¾“å…¥æ¡†æœ‰å†…å®¹æ—¶å¯ç”¨æŒ‰é’®
            if (this.value.trim()) {
                sendButton.style.opacity = '1';
                sendButton.style.cursor = 'pointer';
            } else {
                sendButton.style.opacity = '0.5';
                sendButton.style.cursor = 'default';
            }
        });

        function createCodeHeader(codeBlock, language) {
            const header = document.createElement('div');
            header.className = 'code-header';

            // æ·»åŠ è¯­è¨€æ ‡é¢˜
            const languageSpan = document.createElement('span');
            languageSpan.className = 'code-language';
            languageSpan.textContent = language || 'plaintext';

            // æ·»åŠ å¤åˆ¶æŒ‰é’®
            const copyButton = document.createElement('button');
            copyButton.className = 'copy-button';
            copyButton.innerHTML = 'å¤åˆ¶';
            copyButton.onclick = async () => {
                try {
                    await navigator.clipboard.writeText(codeBlock.textContent);
                    copyButton.innerHTML = 'å·²å¤åˆ¶!';
                    copyButton.classList.add('copied');
                    setTimeout(() => {
                        copyButton.innerHTML = 'å¤åˆ¶';
                        copyButton.classList.remove('copied');
                    }, 2000);
                } catch (err) {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                }
            };

            header.appendChild(languageSpan);
            header.appendChild(copyButton);

            // å°†headeræ’å…¥åˆ°preå…ƒç´ çš„æœ€å‰é¢
            const preElement = codeBlock.parentElement;
            preElement.insertBefore(header, preElement.firstChild);
        }
    </script>
</body>

</html>